# 外部SSH接続対応 - 設計検討記録

## 📅 検討日時
2025年5月29日

## 🎯 検討した方式

### 方式1: Host Networkでの直接アクセス
```yaml
devices:
  eth0:
    name: eth0
    nictype: bridged
    parent: bond0  # または適切なホストインターフェース
    type: nic
```

**メリット**:
- コンテナが直接外部IPを持つ
- 設定がシンプル
- ネットワーク性能が最適

**デメリット**:
- ホストのネットワーク設定に依存
- OVS (Open vSwitch)環境では動作しない場合がある
- セキュリティリスクが高い

**結果**: ❌ 不採用（OVSエラーで動作せず）

### 方式2: ポートフォワーディング
```bash
# ホストサーバーでポートフォワード設定
iptables -t nat -A PREROUTING -p tcp --dport 2222 -j DNAT --to-destination 10.x.x.x:22
```

**メリット**:
- 柔軟な設定が可能
- 既存のファイアウォール設定と統合可能

**デメリット**:
- iptables設定が複雑
- ホストの再起動で設定が消える可能性
- 管理が煩雑

**結果**: ❌ 不採用（より良い方式があるため）

### 方式3: Proxy Device（最もセキュア）
```yaml
devices:
  ssh-proxy:
    type: proxy
    listen: tcp:0.0.0.0:2222
    connect: tcp:127.0.0.1:22
```

**メリット**:
- LXD内で完結する設定
- セキュリティが高い
- 設定の永続性が保証される
- 管理が簡単

**デメリット**:
- LXD 3.0以降でのみ利用可能
- 若干のオーバーヘッド

**結果**: ✅ **採用**

## 🎯 採用方式の詳細

### Proxy Deviceを選択した理由

1. **セキュリティ**: コンテナネットワークを内部に保ちつつ、特定ポートのみ公開
2. **管理性**: LXDプロファイルで完結し、再起動後も設定が維持される
3. **実装の容易さ**: 追加のネットワーク設定やiptables操作が不要
4. **互換性**: 様々なホスト環境で動作

### 実装結果

- **ホストIP**: 192.168.0.131
- **公開ポート**: 2222
- **内部転送先**: コンテナ内部の22番ポート
- **認証方式**: SSH公開鍵認証 + バックアップパスワード

## 📊 セキュリティ考慮事項

### 実装したセキュリティ対策

1. **SSH強化設定**
   - 公開鍵認証の優先
   - 最大認証試行回数: 3回
   - 最大同時セッション: 2
   - rootログイン無効
   - 空パスワード無効

2. **fail2ban設定**
   - 3回失敗で1時間BAN
   - 監視期間: 600秒

3. **UFWファイアウォール**
   - デフォルトで全て拒否
   - SSH（22番）のみ許可
   - LXDブリッジからのアクセス許可

### 検討したが実装しなかったセキュリティ対策

1. **IP制限**: 動的IPユーザーのため見送り
2. **VPN必須化**: 開発利便性を優先
3. **ポート22番の完全無効化**: 内部管理用に残す

## 🔍 テスト結果

### 動作確認項目

- [x] 外部からのSSH接続
- [x] 公開鍵認証
- [x] パスワード認証（バックアップ）
- [x] VS Code Remote-SSH接続
- [x] fail2ban動作
- [x] UFWファイアウォール動作
- [x] プロキシポート（2222）リスニング

### パフォーマンステスト

- SSH接続遅延: 最小限（プロキシオーバーヘッドはほぼ無視できる）
- ファイル転送速度: ホストネットワーク帯域幅に依存
- VS Code操作体感: ローカル開発と同等

## 📝 今後の改善案

1. **監視強化**
   - SSH接続ログの定期監視
   - 異常アクセスのアラート設定

2. **バックアップ**
   - コンテナスナップショットの定期作成
   - 設定ファイルの別途バックアップ

3. **スケーラビリティ**
   - 複数ポートでの複数コンテナ公開
   - リバースプロキシによる統合管理